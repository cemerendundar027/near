import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Emoji picker widget for chat input
class EmojiPickerWidget extends StatefulWidget {
  final void Function(String emoji) onEmojiSelected;
  final VoidCallback? onBackspace;
  final double height;

  const EmojiPickerWidget({
    super.key,
    required this.onEmojiSelected,
    this.onBackspace,
    this.height = 280,
  });

  @override
  State<EmojiPickerWidget> createState() => _EmojiPickerWidgetState();
}

class _EmojiPickerWidgetState extends State<EmojiPickerWidget>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  List<String> _recentEmojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòä', 'ü•∞', 'üòò', 'ü§î', 'üëã'];

  @override
  void initState() {
    super.initState();
    // 9 kategori: Son Kullanƒ±lan, Y√ºzler, ƒ∞nsanlar, Hayvanlar, Yiyecek, Aktivite, Objeler, Semboller, Bayraklar
    _tabController = TabController(length: 9, vsync: this);
    _tabController.addListener(() {
      if (!_tabController.indexIsChanging) {
        setState(() {});
      }
    });
    _loadRecentEmojis();
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  Future<void> _loadRecentEmojis() async {
    final prefs = await SharedPreferences.getInstance();
    final saved = prefs.getStringList('recentEmojis');
    if (saved != null && saved.isNotEmpty && mounted) {
      setState(() => _recentEmojis = saved);
    }
  }

  Future<void> _saveRecentEmoji(String emoji) async {
    // Remove if already exists, then add to front
    _recentEmojis.remove(emoji);
    _recentEmojis.insert(0, emoji);
    // Keep max 24 recent emojis
    if (_recentEmojis.length > 24) {
      _recentEmojis = _recentEmojis.sublist(0, 24);
    }
    setState(() {});
    
    final prefs = await SharedPreferences.getInstance();
    await prefs.setStringList('recentEmojis', _recentEmojis);
  }

  void _onEmojiTapped(String emoji) {
    _saveRecentEmoji(emoji);
    widget.onEmojiSelected(emoji);
  }

  // Emoji categories - now dynamic for recent
  List<_EmojiCategory> get _categories => [
    _EmojiCategory(
      icon: Icons.access_time,
      label: 'Son Kullanƒ±lan',
      emojis: _recentEmojis,
    ),
    _EmojiCategory(
      icon: Icons.emoji_emotions,
      label: 'Y√ºzler',
      emojis: [
        'üòÄ',
        'üòÉ',
        'üòÑ',
        'üòÅ',
        'üòÜ',
        'üòÖ',
        'ü§£',
        'üòÇ',
        'üôÇ',
        'üôÉ',
        'üòâ',
        'üòä',
        'üòá',
        'ü•∞',
        'üòç',
        'ü§©',
        'üòò',
        'üòó',
        '‚ò∫Ô∏è',
        'üòö',
        'üòô',
        'ü•≤',
        'üòã',
        'üòõ',
        'üòú',
        'ü§™',
        'üòù',
        'ü§ë',
        'ü§ó',
        'ü§≠',
        'ü§´',
        'ü§î',
        'ü§ê',
        'ü§®',
        'üòê',
        'üòë',
        'üò∂',
        'üòè',
        'üòí',
        'üôÑ',
        'üò¨',
        'ü§•',
        'üòå',
        'üòî',
        'üò™',
        'ü§§',
        'üò¥',
        'üò∑',
        'ü§í',
        'ü§ï',
        'ü§¢',
        'ü§Æ',
        'ü§ß',
        'ü•µ',
        'ü•∂',
        'ü•¥',
        'üòµ',
        'ü§Ø',
        'ü§†',
        'ü•≥',
        'ü•∏',
        'üòé',
        'ü§ì',
        'üßê',
        'üòï',
        'üòü',
        'üôÅ',
        '‚òπÔ∏è',
        'üòÆ',
        'üòØ',
        'üò≤',
        'üò≥',
        'ü•∫',
        'üò¶',
        'üòß',
        'üò®',
        'üò∞',
        'üò•',
        'üò¢',
        'üò≠',
        'üò±',
        'üòñ',
        'üò£',
        'üòû',
        'üòì',
        'üò©',
        'üò´',
        'ü•±',
        'üò§',
        'üò°',
        'üò†',
        'ü§¨',
        'üòà',
        'üëø',
        'üíÄ',
        '‚ò†Ô∏è',
      ],
    ),
    _EmojiCategory(
      icon: Icons.emoji_people,
      label: 'ƒ∞nsanlar',
      emojis: [
        'üëã',
        'ü§ö',
        'üñêÔ∏è',
        '‚úã',
        'üññ',
        'üëå',
        'ü§å',
        'ü§è',
        '‚úåÔ∏è',
        'ü§û',
        'ü§ü',
        'ü§ò',
        'ü§ô',
        'üëà',
        'üëâ',
        'üëÜ',
        'üñï',
        'üëá',
        '‚òùÔ∏è',
        'üëç',
        'üëé',
        '‚úä',
        'üëä',
        'ü§õ',
        'ü§ú',
        'üëè',
        'üôå',
        'üëê',
        'ü§≤',
        'ü§ù',
        'üôè',
        '‚úçÔ∏è',
        'üí™',
        'ü¶µ',
        'ü¶∂',
        'üëÇ',
        'ü¶ª',
        'üëÉ',
        'üß†',
        'ü´Ä',
        'üëÄ',
        'üëÅÔ∏è',
        'üëÖ',
        'üëÑ',
        'üíã',
        'üë∂',
        'üßí',
        'üë¶',
        'üëß',
        'üßë',
        'üë±',
        'üë®',
        'üßî',
        'üë©',
        'üßì',
        'üë¥',
        'üëµ',
        'üôç',
        'üôé',
        'üôÖ',
        'üôÜ',
        'üíÅ',
        'üôã',
        'üßè',
      ],
    ),
    _EmojiCategory(
      icon: Icons.emoji_nature,
      label: 'Doƒüa',
      emojis: [
        'üê∂',
        'üê±',
        'üê≠',
        'üêπ',
        'üê∞',
        'ü¶ä',
        'üêª',
        'üêº',
        'üê®',
        'üêØ',
        'ü¶Å',
        'üêÆ',
        'üê∑',
        'üê∏',
        'üêµ',
        'üôà',
        'üôâ',
        'üôä',
        'üêî',
        'üêß',
        'üê¶',
        'üê§',
        'ü¶Ü',
        'ü¶Ö',
        'ü¶â',
        'ü¶á',
        'üê∫',
        'üêó',
        'üê¥',
        'ü¶Ñ',
        'üêù',
        'üêõ',
        'ü¶ã',
        'üêå',
        'üêû',
        'üêú',
        'ü™≤',
        'ü™≥',
        'ü¶ü',
        'ü¶ó',
        'üï∑Ô∏è',
        'ü¶Ç',
        'üê¢',
        'üêç',
        'ü¶é',
        'ü¶ñ',
        'ü¶ï',
        'üêô',
        'üå∏',
        'üíÆ',
        'üèµÔ∏è',
        'üåπ',
        'ü•Ä',
        'üå∫',
        'üåª',
        'üåº',
        'üå∑',
        'üå±',
        'ü™¥',
        'üå≤',
        'üå≥',
        'üå¥',
        'üåµ',
        'üåæ',
      ],
    ),
    _EmojiCategory(
      icon: Icons.emoji_food_beverage,
      label: 'Yemek',
      emojis: [
        'üçé',
        'üçê',
        'üçä',
        'üçã',
        'üçå',
        'üçâ',
        'üçá',
        'üçì',
        'ü´ê',
        'üçà',
        'üçí',
        'üçë',
        'ü•≠',
        'üçç',
        'ü••',
        'ü•ù',
        'üçÖ',
        'üçÜ',
        'ü•ë',
        'ü•¶',
        'ü•¨',
        'ü•í',
        'üå∂Ô∏è',
        'ü´ë',
        'üåΩ',
        'ü•ï',
        'ü´í',
        'üßÑ',
        'üßÖ',
        'ü•î',
        'üç†',
        'ü•ê',
        'ü•Ø',
        'üçû',
        'ü•ñ',
        'ü•®',
        'üßÄ',
        'ü•ö',
        'üç≥',
        'üßà',
        'ü•û',
        'üßá',
        'ü•ì',
        'ü•©',
        'üçó',
        'üçñ',
        'ü¶¥',
        'üå≠',
        'üçî',
        'üçü',
        'üçï',
        'ü´ì',
        'ü•™',
        'ü•ô',
        'üßÜ',
        'üåÆ',
        'üåØ',
        'ü´î',
        'ü•ó',
        'ü•ò',
        'ü´ï',
        'üçù',
        'üçú',
        'üç≤',
        '‚òï',
        'üçµ',
        'üßÉ',
        'ü•§',
        'üßã',
        'üç∂',
        'üç∫',
        'üçª',
        'ü•Ç',
        'üç∑',
        'ü•É',
        'üç∏',
        'üçπ',
        'üßâ',
        'üçæ',
        'üßä',
      ],
    ),
    _EmojiCategory(
      icon: Icons.emoji_events,
      label: 'Aktiviteler',
      emojis: [
        '‚öΩ',
        'üèÄ',
        'üèà',
        '‚öæ',
        'ü•é',
        'üéæ',
        'üèê',
        'üèâ',
        'ü•è',
        'üé±',
        'ü™Ä',
        'üèì',
        'üè∏',
        'üèí',
        'üèë',
        'ü•ç',
        'üèè',
        'ü™É',
        'ü•Ö',
        '‚õ≥',
        'ü™Å',
        'üèπ',
        'üé£',
        'ü§ø',
        'ü•ä',
        'ü•ã',
        'üéΩ',
        'üõπ',
        'üõº',
        'üõ∑',
        '‚õ∏Ô∏è',
        'ü•å',
        'üéø',
        '‚õ∑Ô∏è',
        'üèÇ',
        'ü™Ç',
        'üèãÔ∏è',
        'ü§º',
        'ü§∏',
        '‚õπÔ∏è',
        'ü§∫',
        'ü§æ',
        'üèåÔ∏è',
        'üèá',
        '‚õ∑Ô∏è',
        'üèä',
        'üö¥',
        'üöµ',
        'üé™',
        'üé≠',
        'üé®',
        'üé¨',
        'üé§',
        'üéß',
        'üéº',
        'üéπ',
        'ü•Å',
        'ü™ò',
        'üé∑',
        'üé∫',
        'ü™ó',
        'üé∏',
        'ü™ï',
        'üéª',
      ],
    ),
    _EmojiCategory(
      icon: Icons.emoji_objects,
      label: 'Objeler',
      emojis: [
        '‚åö',
        'üì±',
        'üì≤',
        'üíª',
        '‚å®Ô∏è',
        'üñ•Ô∏è',
        'üñ®Ô∏è',
        'üñ±Ô∏è',
        'üíΩ',
        'üíæ',
        'üíø',
        'üìÄ',
        'üìº',
        'üì∑',
        'üì∏',
        'üìπ',
        'üé•',
        'üìΩÔ∏è',
        'üéûÔ∏è',
        'üìû',
        '‚òéÔ∏è',
        'üìü',
        'üì†',
        'üì∫',
        'üìª',
        'üéôÔ∏è',
        'üéöÔ∏è',
        'üéõÔ∏è',
        'üß≠',
        '‚è±Ô∏è',
        '‚è≤Ô∏è',
        '‚è∞',
        'üï∞Ô∏è',
        '‚åõ',
        '‚è≥',
        'üì°',
        'üîã',
        'üîå',
        'üí°',
        'üî¶',
        'üïØÔ∏è',
        'ü™î',
        'üßØ',
        'üõ¢Ô∏è',
        'üí∏',
        'üíµ',
        'üí¥',
        'üí∂',
        'üí∑',
        'ü™ô',
        'üí∞',
        'üí≥',
        'üíé',
        '‚öñÔ∏è',
        'ü™ú',
        'üß∞',
        'ü™õ',
        'üîß',
        'üî®',
        '‚öíÔ∏è',
        'üõ†Ô∏è',
        '‚õèÔ∏è',
        'ü™ö',
        'üî©',
      ],
    ),
    _EmojiCategory(
      icon: Icons.emoji_symbols,
      label: 'Semboller',
      emojis: [
        '‚ù§Ô∏è',
        'üß°',
        'üíõ',
        'üíö',
        'üíô',
        'üíú',
        'üñ§',
        'ü§ç',
        'ü§é',
        'üíî',
        '‚ù£Ô∏è',
        'üíï',
        'üíû',
        'üíì',
        'üíó',
        'üíñ',
        'üíò',
        'üíù',
        'üíü',
        '‚òÆÔ∏è',
        '‚úùÔ∏è',
        '‚ò™Ô∏è',
        'üïâÔ∏è',
        '‚ò∏Ô∏è',
        '‚ú°Ô∏è',
        'üîØ',
        'üïé',
        '‚òØÔ∏è',
        '‚ò¶Ô∏è',
        'üõê',
        '‚õé',
        '‚ôà',
        '‚ôâ',
        '‚ôä',
        '‚ôã',
        '‚ôå',
        '‚ôç',
        '‚ôé',
        '‚ôè',
        '‚ôê',
        '‚ôë',
        '‚ôí',
        '‚ôì',
        'üÜî',
        '‚öõÔ∏è',
        'üâë',
        '‚ò¢Ô∏è',
        '‚ò£Ô∏è',
        'üì¥',
        'üì≥',
        'üà∂',
        'üàö',
        'üà∏',
        'üà∫',
        'üà∑Ô∏è',
        '‚ú¥Ô∏è',
        'üÜö',
        'üíÆ',
        'üâê',
        '„äôÔ∏è',
        '„äóÔ∏è',
        'üà¥',
        'üàµ',
        'üàπ',
        '‚úÖ',
        '‚òëÔ∏è',
        '‚úîÔ∏è',
        '‚ùå',
        '‚ùé',
        '‚ûï',
        '‚ûñ',
        '‚ûó',
        '‚û∞',
        '‚ûø',
        '„ÄΩÔ∏è',
        '‚ú≥Ô∏è',
        '‚ú¥Ô∏è',
        '‚ùáÔ∏è',
        '¬©Ô∏è',
        '¬ÆÔ∏è',
      ],
    ),
    _EmojiCategory(
      icon: Icons.flag,
      label: 'Bayraklar',
      emojis: [
        'üáπüá∑',
        'üá∫üá∏',
        'üá¨üáß',
        'üá©üá™',
        'üá´üá∑',
        'üá™üá∏',
        'üáÆüáπ',
        'üá≥üá±',
        'üáßüá™',
        'üá¶üáπ',
        'üá®üá≠',
        'üá∏üá™',
        'üá≥üá¥',
        'üá©üá∞',
        'üá´üáÆ',
        'üáµüá±',
        'üá∑üá∫',
        'üá∫üá¶',
        'üá¨üá∑',
        'üáµüáπ',
        'üáßüá∑',
        'üá¶üá∑',
        'üá≤üáΩ',
        'üá®üá¶',
        'üá¶üá∫',
        'üáØüáµ',
        'üá∞üá∑',
        'üá®üá≥',
        'üáÆüá≥',
        'üáÆüá©',
        'üá∏üá¶',
        'üá¶üá™',
        'üá™üá¨',
        'üáøüá¶',
        'üá≥üá¨',
        'üá∞üá™',
        'üá≤üá¶',
        'üáπüá≥',
        'üá¶üáø',
        'üá¨üá™',
      ],
    ),
  ];

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      height: widget.height,
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1C1C1E) : Colors.white,
        border: Border(
          top: BorderSide(color: isDark ? Colors.white12 : Colors.black12),
        ),
      ),
      child: Column(
        children: [
          // Category tabs
          Container(
            height: 44,
            decoration: BoxDecoration(
              border: Border(
                bottom: BorderSide(
                  color: isDark ? Colors.white12 : Colors.black12,
                ),
              ),
            ),
            child: TabBar(
              controller: _tabController,
              isScrollable: true,
              indicatorSize: TabBarIndicatorSize.label,
              indicatorColor: const Color(0xFF7B3FF2),
              labelColor: const Color(0xFF7B3FF2),
              unselectedLabelColor: isDark ? Colors.white54 : Colors.black54,
              tabAlignment: TabAlignment.start,
              tabs: _categories
                  .map((c) => Tab(icon: Icon(c.icon, size: 22)))
                  .toList(),
            ),
          ),

          // Emoji grid
          Expanded(
            child: TabBarView(
              controller: _tabController,
              children: _categories.map((category) {
                return GridView.builder(
                  padding: const EdgeInsets.all(8),
                  gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                    crossAxisCount: 8,
                    childAspectRatio: 1,
                  ),
                  itemCount: category.emojis.length,
                  itemBuilder: (context, index) {
                    final emoji = category.emojis[index];
                    return GestureDetector(
                      onTap: () => _onEmojiTapped(emoji),
                      child: Container(
                        alignment: Alignment.center,
                        child: Text(
                          emoji,
                          style: const TextStyle(fontSize: 26),
                        ),
                      ),
                    );
                  },
                );
              }).toList(),
            ),
          ),

          // Bottom bar with backspace
          Container(
            height: 44,
            padding: const EdgeInsets.symmetric(horizontal: 8),
            decoration: BoxDecoration(
              border: Border(
                top: BorderSide(
                  color: isDark ? Colors.white12 : Colors.black12,
                ),
              ),
            ),
            child: Row(
              children: [
                // Search (placeholder)
                Expanded(
                  child: Container(
                    height: 32,
                    margin: const EdgeInsets.symmetric(vertical: 6),
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(
                      color: isDark ? Colors.white10 : Colors.grey.shade200,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.search,
                          size: 18,
                          color: isDark ? Colors.white38 : Colors.black38,
                        ),
                        const SizedBox(width: 8),
                        Text(
                          'Emoji ara',
                          style: TextStyle(
                            color: isDark ? Colors.white38 : Colors.black38,
                            fontSize: 14,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                // Backspace
                GestureDetector(
                  onTap: widget.onBackspace,
                  onLongPress: widget.onBackspace,
                  child: Container(
                    width: 44,
                    height: 32,
                    decoration: BoxDecoration(
                      color: isDark ? Colors.white10 : Colors.grey.shade200,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      Icons.backspace_outlined,
                      size: 20,
                      color: isDark ? Colors.white54 : Colors.black54,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _EmojiCategory {
  final IconData icon;
  final String label;
  final List<String> emojis;

  const _EmojiCategory({
    required this.icon,
    required this.label,
    required this.emojis,
  });
}
